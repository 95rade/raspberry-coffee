<!DOCTYPE html>
<html>
<head>
	<title>Log Manager</title>
	<meta charset="utf-8">
	<link rel="icon" type="image/jpg" href="icons/palm.04.jpg">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="./css/jquery.mobile-1.3.2.min.css"/>
	<script src="js/jquery-2.1.3.js"></script>
	<script src="./js/jquery.mobile-1.3.2.min.js"></script>
	<script type="text/javascript" src="js/mux.rest.js"></script>
	<style>
		.scrollable-file-name {
			width: 350px;
			border: 1px solid silver;
			border-radius: 5px;
			white-space: nowrap;
			overflow-x: auto;
			text-align: right;
		}
	</style>
	<script type="text/javascript">

	var getLogFilesList = function() {
    var getData = getLogFiles(); // A promise
    getData.done(function(value) {
	    var json = JSON.parse(value);
//    console.log("Log files", json);
	    buildFileList(json);
    });
    getData.fail(function(error, errmess) {
        var message;
        if (errmess !== undefined) {
            if (errmess.message !== undefined) {
                message = errmess.message;
            } else {
                message = errmess;
            }
        }
        console.log("Failed to get the log files list..." + (error !== undefined ? error : ' - ') + ', ' + (message !== undefined ? message : ' - '));
    });
  };

	var deleteLog = function(fName) {
		var deleteData = deleteLogFile(fName); // A promise
		deleteData.done(function(value) {
//		var json = JSON.parse(value);
	    console.log("Delete log file OK");
	    // Rebuild the list
			getLogFilesList();
		});
		deleteData.fail(function(error, errmess) {
			var message;
			if (errmess !== undefined) {
				if (errmess.message !== undefined) {
					message = errmess.message;
				} else {
					message = errmess;
				}
			}
			console.log("Failed to delete the log file..." + (error !== undefined ? error : ' - ') + ', ' + (message !== undefined ? message : ' - '));
		});
	};


	function buildFileList(fileArray) {
		let tableHtml = '';
		document.getElementById("count").innerText = "Found " + fileArray.length + " log file(s)";
		fileArray.forEach(lf => {
			tableHtml +=
					'<tr>\n' +
					'  <td><div class="scrollable-file-name"><a href="/mux/log-files/' + encodeURIComponent(lf) + '" target="ext" title="Click to download">' + lf + '</a></div></td>\n' +
					'  <td><button onclick="deleteLog(\'' + encodeURIComponent(lf) + '\');" title="Delete log file" style="width: 24px; height: 24px; border-radius: 12px; padding: 0;"><img src="icons/delete.png" width="16" height="16" style="vertical-align: middle;"></button></td>\n' +
					'</tr>\n';
		});

		document.getElementById("table-body").innerHTML = tableHtml;

	}
  window.onload = getLogFilesList();

		</script>
</head>
<body>
<div id="main">
    <div >
			<h1 style="margin-left: 10px;"><span onclick="window.history.back();" title="Go back">&#8678;&nbsp;</span> Log Manager <img src="icons/reload.png" title="reload page" width="36" height="36" style="vertical-align: middle; margin-left: 20px;" onclick="location.reload();"></h1>
    </div>

    <div id="file-table">
			<div id="count" style="margin-left: 10px;"></div>
			<!--table data-role="table" id="files-table" data-mode="reflow" class="ui-responsive"-->
			<table id="log-files-table" style="margin: auto;">
				<thead>
				<tr>
					<th>File Name</th>
					<th></th>
				</tr>
				</thead>
				<tbody id="table-body">

				<!--tr>
					<td><a href="/mux/log-files/data.nmea" target="ext">./data.nmea</a></td>
					<td>Delete</td>
				</tr>
				<tr>
					<td><a href="/mux/log-files/tomales%2Fdata.shrinked.nmea" target="ext">./tomales/data.shrinked.nmea</a></td>
					<td>Delete</td>
				</tr>
				<tr>
					<td><a href="/mux/log-files/tomales%2Fdata.ais.shrinked.nmea" target="ext">./tomales/data.ais.shrinked.nmea</a></td>
					<td>Delete</td>
				</tr>
				<tr>
					<td><a href="/mux/log-files/logged%2F2018-10-23_15:56:00_UTC_LOG.nmea" target="ext">./logged/2018-10-23_15:56:00_UTC_LOG.nmea</a></td>
					<td>Delete</td>
				</tr-->

				</tbody>
			</table>

		</div>
    <div style="display: none"> <!-- turn display to block or inline for debugging -->
        <textarea id="message" style="width: 98%; height: 150px;"></textarea>
    </div>
</div>
<script>

</script>
</body>
</html>
