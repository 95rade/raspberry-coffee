<!DOCTYPE html>
<html lang="en">
<!--
 ! Get the data from navrest.NavServer, started for example by ./runNavServer.sh
 ! Uses ES6 Promises to get to Ajax
 +-->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sight Reduction</title>
	<link rel="icon" type="image/gif" href="./sextant.gif">
	<link rel="stylesheet" href="./stylesheet.css">
	<!-- Scripts -->
	<script type="text/javascript" src="./ajax.manager.js"></script>
	<script type="text/javascript">

		function decToSex(val, ns_ew) {
			var absVal = Math.abs(val);
			var intValue = Math.floor(absVal);
			var dec = absVal - intValue;
			var i = intValue;
			dec *= 60;
			var s = "";
			if (ns_ew !== undefined) {
				if (val < 0) {
					s += (ns_ew === 'NS' ? 'S' : 'W');
				} else {
					s += (ns_ew === 'NS' ? 'N' : 'E');
				}
			}
			s += " ";
			s += i + "&deg;" + dec.toFixed(2) + "'";
			return s;
		}

		function updateFieldToNow() {
			let now = new Date();
			let year = now.getUTCFullYear();
			let month = now.getUTCMonth() + 1;
			let day = now.getUTCDate();
			let hours = now.getUTCHours();
			let minutes = now.getUTCMinutes();
			let seconds = now.getUTCSeconds();

			document.getElementById('calendar-year-01').value = year;
			document.getElementById('calendar-month-01').value = (month < 10 ? '0' + month : month);
			document.getElementById('calendar-day-01').value = day;
			document.getElementById('watch-value-01').value =
					(hours < 10 ? '0' + hours : hours) + ':' +
					(minutes < 10 ? '0' + minutes : minutes) + ':' +
					(seconds < 10 ? '0' + seconds : seconds);
		}

		/*
		  Sample payload:
		{
		  "estimatedPosition": {
		    "latitude": 37.409,
		    "longitude": -122.7654
			},
			"utcDate": "2018-11-05T20:50:52",
		  "cbd": {
		    "name": "Sun",
		    "instrumentalAltitude": 35.074,
		    "limb": "LOWER",
				"eyeHeight": 1.8
			}
		}
		 */
		function calculate() {
			// Gather data
			let day = document.getElementById('calendar-day-01').value;
			let utcDate =
					document.getElementById('calendar-year-01').value + '-' +
					document.getElementById('calendar-month-01').value + '-' +
					(day.length < 2 ? '0' : '') + day + 'T' +
					document.getElementById('watch-value-01').value;
			let latitude =
					(parseInt(document.getElementById('pos-lat-deg-01').value) +
					(parseFloat(document.getElementById('pos-lat-min-01').value) / 60)) *
					(document.getElementById('pos-lat-sign-01').value === 'S' ? (-1) : 1);
			let longitude =
					(parseInt(document.getElementById('pos-lng-deg-01').value) +
					(parseFloat(document.getElementById('pos-lng-min-01').value) / 60)) *
					(document.getElementById('pos-lng-sign-01').value === 'W' ?  (-1) : 1);

			let body = document.getElementById('celestial-body').value;
			let limb = document.getElementById('limb').value;

			let sextantAltitude =
					parseInt(document.getElementById('sextant-degrees').value) +
					(parseFloat(document.getElementById('sextant-minutes').value) / 60);

			let eyeHeight = parseFloat(document.getElementById('eye-height').value);

			let requestPayload = {
				"estimatedPosition": {
					"latitude": latitude,
					"longitude": longitude
				},
				"utcDate": utcDate,
				"cbd": {
					"name": body,
					"instrumentalAltitude": sextantAltitude,
					"limb": limb,
					"eyeHeight": eyeHeight
				}
			};
			// Create and invoke promise
			let srCallback = function(result) {
				/*
				Result looks like: {
					estimated-altitude-degrees: 25.311551122752217
					horizon-depression-minutes: 2.361287784239778
					horizontal-parallax-minutes: 0.14786556508924234
					intercept-degrees: 0.2529271027923592
					observed-altitude-degrees: 25.564478225544576
					parallax-minutes: 0.13369003931944906
					refraction-minutes: 2.0392820936344154
					semi-diameter-minutes: 16.135573371229203
					total-correction-minutes: 11.868693532674458
					z: 138.96942242930982,
					delta-t: 68.9677
				}
				*/
		//	console.log("Result:", result);

				let fmtDisplay = "<hr/>";
				fmtDisplay += ("Intercept: " + Math.abs(result['intercept-degrees'] * 60).toFixed(2) + "' " + (result['intercept-degrees']<0?"away from":"towards") + " " + body);
				fmtDisplay += ("<br>Z:" + result['z'].toFixed(2) + '&deg;');
				fmtDisplay += ("<br>Observed Altitude (corrected):" + decToSex(result['observed-altitude-degrees']));
				fmtDisplay += ("<br>Estimated Altitude (at estimated pos):" + decToSex(result['estimated-altitude-degrees']));
				fmtDisplay += ("<br>Total correction in minutes:" + result['total-correction-minutes'].toFixed(4));
				fmtDisplay += ("<hr/>");
				fmtDisplay += ("<i>Calculated with DeltaT = " + result['delta-t'] + ' s</i>');
				fmtDisplay += ("<hr/>");

				document.getElementById("result").innerHTML = fmtDisplay;
			};
			calculateSightReduction(requestPayload, srCallback);
		}

	</script>
</head>
<body>

	<table width="100%">
		<tr>
			<td><h1>Sight Reduction</h1></td>
			<td><img src="sextant.gif" alt="Sextant"></td>
		</tr>
	</table>
	<hr/>

	<!-- A div for the user to set the UTC time -->
	<div id="user-time-set">
		<div id="user-time-widgets" style="display: block; padding: 10px;">
			<span style="margin: 5px;">UTC Date of observation:</span>
			<input type="number"
						 id="calendar-day-01"
						 placeholder="DD"
						 title="Day to set"
						 style="width: 40px; text-align: center;"
						 value="01"/>
			<select id="calendar-month-01">
				<option value="01" selected>Jan</option>
				<option value="02">Feb</option>
				<option value="03">Mar</option>
				<option value="04">Apr</option>
				<option value="05">May</option>
				<option value="06">Jun</option>
				<option value="07">Jul</option>
				<option value="08">Aug</option>
				<option value="09">Sep</option>
				<option value="10">Oct</option>
				<option value="11">Nov</option>
				<option value="12">Dec</option>
			</select>
			<input type="number"
						 id="calendar-year-01"
						 placeholder="YYYY"
						 title="Year to set"
						 style="width: 60px; text-align: center;"
						 value="1970"/>
			<input type="text"
						 id="watch-value-01"
						 placeholder="00:00:00"
						 title="UTC Time to set"
						 style="width: 80px; text-align: center;"
						 value="00:00:00"/>
			&nbsp;&nbsp;
			<button id="button-now"
							onclick="updateFieldToNow()"
							title="Set date value to current time"
							style="margin-top: 3px; border-radius: 3px; box-shadow: 2px 2px silver;">Now</button>
		</div>
		<div id="user-pos-widgets" style="display: block; padding: 10px;">
			<table>
				<tr>
					<td>Estimated Latitude:</td>
					<td>
						<select id="pos-lat-sign-01">
							<option value="N" selected>N</option>
							<option value="S">S</option>
						</select>
					</td>
					<td>
						<input type="number"
									 id="pos-lat-deg-01"
									 placeholder="Deg"
									 title="Lat degrees to set"
									 style="width: 40px; text-align: center;"
									 min="0"
									 max="90"
									 step="1"
									 value="0"/>
						<span>&deg;</span>
					</td>
					<td>
						<input type="number"
									 id="pos-lat-min-01"
									 placeholder="Minutes"
									 title="Lat minutes to set"
									 style="width: 60px; text-align: center;"
									 min="0"
									 max="59.99"
									 step="0.01"
									 value="00.00"/>
						<span>'</span>
					</td>
				</tr>
			  <tr>
					<td>Estimated Longitude:</td>
					<td>
						<select id="pos-lng-sign-01">
							<option value="E" selected>E</option>
							<option value="W">W</option>
						</select>
					</td>
					<td>
						<input type="number"
									 id="pos-lng-deg-01"
									 placeholder="Deg"
									 title="Lng degrees to set"
									 style="width: 40px; text-align: center;"
									 min="0"
									 max="180"
									 step="1"
									 value="0"/>
						<span>&deg;</span>
					</td>
					<td>
						<input type="number"
									 id="pos-lng-min-01"
									 placeholder="Minutes"
									 title="Lng minutes to set"
									 style="width: 60px; text-align: center;"
									 min="0"
									 max="59.99"
									 step="0.01"
									 value="00.00"/>
						<span>'</span>
					</td>
				</tr>
			</table>
		</div>
		<div id="user-obs-widgets" style="display: block; padding: 10px;">
			<table>
				<tr>
					<td>Body:</td>
					<td>
						<!-- Body list -->
						<select id="celestial-body">
							<option value="Sun" selected>Sun</option>
							<option value="Moon">Moon</option>
							<option value="Venus">Venus</option>
							<option value="Mars">Mars</option>
							<option value="Jupiter">Jupiter</option>
							<option value="Saturn">Saturn</option>
							<option value="Acamar">Acamar</option>
							<option value="Achenar">Achenar</option>
							<option value="Acrux">Acrux</option>
							<option value="Adhara">Adhara</option>
							<option value="Aldebaran">Aldebaran</option>
							<option value="Alioth">Alioth</option>
							<option value="Alkaid">Alkaid</option>
							<option value="Al Na'ir">Al Na'ir</option>
							<option value="Alnilam">Alnilam</option>
							<option value="Alphard">Alphard</option>
							<option value="Alphecca">Alphecca</option>
							<option value="Alpheratz">Alpheratz</option>
							<option value="Altair">Altair</option>
							<option value="Ankaa">Ankaa</option>
							<option value="Antares">Antares</option>
							<option value="Arcturus">Arcturus</option>
							<option value="Atria">Atria</option>
							<option value="Avior">Avior</option>
							<option value="Bellatrix">Bellatrix</option>
							<option value="Betelgeuse">Betelgeuse</option>
							<option value="Canopus">Canopus</option>
							<option value="Capella">Capella</option>
							<option value="Deneb">Deneb</option>
							<option value="Denebola">Denebola</option>
							<option value="Diphda">Diphda</option>
							<option value="Dubhe">Dubhe</option>
							<option value="Elnath">Elnath</option>
							<option value="Eltanin">Eltanin</option>
							<option value="Enif">Enif</option>
							<option value="Fomalhaut">Fomalhaut</option>
							<option value="Gacrux">Gacrux</option>
							<option value="Gienah">Gienah</option>
							<option value="Hadar">Hadar</option>
							<option value="Hamal">Hamal</option>
							<option value="Kaus Australis">Kaus Australis</option>
							<option value="Kochab">Kochab</option>
							<option value="Markab">Markab</option>
							<option value="Menkar">Menkar</option>
							<option value="Menkent">Menkent</option>
							<option value="Miaplacidus">Miaplacidus</option>
							<option value="Mirfak">Mirfak</option>
							<option value="Nunki">Nunki</option>
							<option value="Peacock">Peacock</option>
							<option value="Polaris">Polaris</option>
							<option value="Pollux">Pollux</option>
							<option value="Procyon">Procyon</option>
							<option value="Rasalhague">Rasalhague</option>
							<option value="Regulus">Regulus</option>
							<option value="Rigel">Rigel</option>
							<option value="Rigil Kent">Rigil Kent</option>
							<option value="Sabik">Sabik</option>
							<option value="Schedar">Schedar</option>
							<option value="Shaula">Shaula</option>
							<option value="Sirius">Sirius</option>
							<option value="Spica">Spica</option>
							<option value="Suhail">Suhail</option>
							<option value="Vega">Vega</option>
							<option value="Zubenelgenubi">Zubenelgenubi</option>
						</select>

						<!-- Upper/Lower limb -->
						<select id="limb">
							<option value="LOWER" selected>Lower Limb</option>
							<option value="UPPER">Upper Limb</option>
						</select>

					</td>
				</tr>
				<tr>
					<!-- Instrumental altitude -->
					<td>Sextant Altitude:</td>
					<td>
						<input type="number"
									 id="sextant-degrees"
									 placeholder="Deg"
									 title="Altitude degrees"
									 style="width: 40px; text-align: center;"
									 min="0"
									 max="90"
									 step="1"
									 value="0"/>
						<span>&deg;</span>
						<input type="number"
									 id="sextant-minutes"
									 placeholder="Minutes"
									 title="Altitude minutes"
									 style="width: 60px; text-align: center;"
									 min="0"
									 max="59.99"
									 step="0.01"
									 value="00.00"/>
						<span>'</span>
					</td>
				</tr>
				<tr>
					<td>Eye Height (meters)</td>
					<td>
						<input type="number"
									 id="eye-height"
									 placeholder="Meters"
									 title="Eye height above surface"
									 style="width: 60px; text-align: center;"
									 min="0"
									 step="0.1"
									 value="1.8"/>
						<span>m</span>
					</td>
				</tr>
			</table>
		</div>
		<div>
			<button onclick="calculate();" style="border-radius: 3px; box-shadow: 2px 2px silver;">Calculate</button>
		</div>
		<div id="result" style="margin: 10px;	"></div>
	</div>


</body>
</html>
