<!DOCTYPE html>
<!--
 | No server required, just displays the map, Mercator projection
 +-->
<html>
  <head>
    <!--meta charset="windows-1252"-->
    <!--meta charset="iso-8859-1"-->
    <!--meta charset="utf-8"-->
    <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
    <title>World Map Demo</title>

    <link rel="icon" type="image/ico" href="../icons/hammerhead.02.ico">

    <link rel="stylesheet" href="../css/stylesheet.css" type="text/css"/>
		<link rel="stylesheet" href="../css/black.css" type="text/css" id="theme"/>
		<link rel="stylesheet" href="../css/worldmap.02.css" type="text/css"/>

		<script type="text/javascript" src="../js/jquery-2.1.3.js"></script>
		<script type="text/javascript" src="../widgets/WorldMapData.js"></script>
		<script type="text/javascript" src="../js/mercator.utils.js"></script>
    <script type="text/javascript" src="../widgets/worldmap.js"></script>
    <script type="text/javascript" src="../js/conversion.utils.js"></script>
    <script type="text/javascript" src="../js/routes.utils.js"></script>
		<script type="text/javascript" src="../catalog/catalog.js"></script>
		<script type="text/javascript" src="ww.js"></script>
    <script type="text/javascript">
    
  var flavor = 'Ajax'; // Default, WebSocket not implemented here (we run on a small http server).

  var currentFax = 1;

  window.onload = function() {
	  init(); // init UI

	  worldMap.clear();
	  worldMap.setPositionLabel("");
	  setTimeout(function () {
		  worldMap.drawWorldMap();
	  }, 1);

	  document.getElementById("console-type").innerHTML = 'The HTML5 ' + flavor + ' Console.';
  };

  var displayErr = function(err) {
    if (err !== undefined) {
	    document.getElementById("err-mess").innerHTML = ("<small>" + err + "</small>");
    }
  };

  var changeGrid = function(cb) {
  	worldMap.setWithGrid(cb.checked);
	  worldMap.drawWorldMap();
  };
  var changeTropics = function(cb) {
    worldMap.setWithTropics(cb.checked);
	  worldMap.drawWorldMap();
  };

  var changeCanvasWidth = function(factor) {
    worldMap.setCanvasWidth(worldMap.getCanvasWidth() * factor);
  };
  var changeCanvasHeight = function(factor) {
    worldMap.setCanvasHeight(worldMap.getCanvasHeight() * factor);
  };
  var changeCanvasSize = function(factor) {
	  worldMap.setCanvasHeight(worldMap.getCanvasHeight() * factor);
	  worldMap.setCanvasWidth(worldMap.getCanvasWidth() * factor);
  };
  var changeZoomRatio = function(factor) {
  	var zoomRatio = worldMap.getZoomRatio() * factor;
  	worldMap.setZoomRatio(zoomRatio);
	};
  var resetZoomRatio = function() {
	  worldMap.resetZoomRatio();
  };

  var show = [true, true, true];

  // For 3 faxes Sfc, 500mb, StreamLines
  var zoom = [0.3418498710866215, 0.5209310701416114, 1.0040821009550305];
  var topLeft = [
	  [10, 10],
	  [15, 30],
	  [-41, 460]
  ];
  var faxObj = [];

  var faxRequestCallback = function(val, originalRequest) {
		var returned = JSON.parse(val);

	  var canvas = document.getElementById('mapCanvas');
	  var context = canvas.getContext('2d');

	  // get data from originalRequest
		faxObj = [];
		for (var idx=0; idx<originalRequest.faxData.length; idx++) {
			var fax = new Image();
			var x = originalRequest.faxData[idx].location.x;
			var y = originalRequest.faxData[idx].location.y;
			var zoom = originalRequest.faxData[idx].zoom;
			fax.onload = function () {
				context.drawImage(fax, x, y, (parseInt(fax.width) * zoom), (parseInt(fax.height) * zoom));
			};
			// Assume that returned and originalRequest have the name cardinality
			fax.src = '../../' + returned[idx].returned; // Tweak for another context...
			console.log(fax.src);
			faxObj.push(fax);
		}
//
//	  // Hard coded for now
//	  var faxObj_1 = new Image();
//	  var faxObj_2 = new Image();
//	  var faxObj_3 = new Image();
//
//	  var zoom = [0.3418498710866215, 0.5209310701416114, 1.0040821009550305];
//	  var topLeft = [
//		  [10, 10],
//		  [15, 30],
//		  [-41, 460]
//	  ];
//	  faxObj_1.onload = function() {
//		  context.drawImage(faxObj_1, topLeft[0][0], topLeft[0][1], (parseInt(faxObj_1.width) * zoom[0]), (parseInt(faxObj_1.height) * zoom[0]));
//	  };
//	  faxObj_2.onload = function() {
//		  context.drawImage(faxObj_2, topLeft[1][0], topLeft[1][1], (parseInt(faxObj_2.width) * zoom[1]), (parseInt(faxObj_2.height) * zoom[1]));
//	  };
//	  faxObj_3.onload = function() {
//		  context.drawImage(faxObj_3, topLeft[2][0], topLeft[2][1], (parseInt(faxObj_3.width) * zoom[2]), (parseInt(faxObj_3.height) * zoom[2]));
//	  };
//	  faxObj_1.src = '../_fax_0.png';
//	  faxObj_2.src = '../_fax_1.png';
//	  faxObj_3.src = '../_fax_2.png';
  };

  var loadFaxes = function() {
  	var compositeData = compositeCatalog[0];

  	console.log(compositeData);
	  worldMap.setCanvasWidth(compositeData.canvas.w);
	  worldMap.setCanvasHeight(compositeData.canvas.h);
	  worldMap.setNorth(compositeData.map.north);
	  worldMap.setSouth(compositeData.map.south);
	  worldMap.setWest(compositeData.map.west);
	  worldMap.setEast(compositeData.map.east); // Recalculated, anyway.
		worldMap.setProjection(compositeData.map.projection);

		worldMap.drawWorldMap();

		var requestData = [];
		compositeData.faxData.forEach(function(fax, idx) {
			var oneFax = {
				url: fax.faxUrl,
				storage: 'web/fax_' + idx + '.png',
				returned: 'web/_fax_' + idx + '.png',
				transparent: fax.transp,
				imgType: "png",
				tx: fax.effect
			};
			if (fax.tx !== undefined) {
				oneFax.from = fax.tx.from;
				oneFax.to = fax.tx.to;
			}
			requestData.push(oneFax);
		});
		// Request ready
		console.log(requestData);
	  getCompositeData(requestData, compositeData, faxRequestCallback);

	};

  var speakUp = function(num) {
	  switch (num) {
		  case 1:
		  case "1":
			  document.getElementById("fax-1").innerText = 'Fax #1: x=' + topLeft[0][0] + ", y=" + topLeft[0][1] + ', zoom=' + zoom[0];
			  break;
		  case 2:
		  case "2":
			  document.getElementById("fax-2").innerText = 'Fax #2: x=' + topLeft[1][0] + ", y=" + topLeft[1][1] + ', zoom=' + zoom[1];
			  break;
		  case 3:
		  case "3":
			  document.getElementById("fax-3").innerText = 'Fax #3: x=' + topLeft[2][0] + ", y=" + topLeft[2][1] + ', zoom=' + zoom[2];
			  break;
		  default:
			  break;
	  }
  };

  var zoomFax = function(num, factor) {
	  zoom[num - 1] *= factor;
	  speakUp(num);
	  redraw();
  };

  var zoomIn = function() {
	  var factor = parseFloat(document.getElementById("zoom-factor").value);
	  zoomFax(currentFax, factor);
  };
  var zoomOut = function() {
	  var factor = parseFloat(document.getElementById("zoom-factor").value);
	  zoomFax(currentFax, 1 / factor);
  };

  var up = function() {
	  topLeft[currentFax - 1][1] -= 1;
	  speakUp(currentFax);
	  redraw();
  };
  var down = function() {
	  topLeft[currentFax - 1][1] += 1;
	  speakUp(currentFax);
	  redraw();
  };
  var left = function() {
	  topLeft[currentFax - 1][0] -= 1;
	  speakUp(currentFax);
	  redraw();
  };
  var right = function() {
	  topLeft[currentFax - 1][0] += 1;
	  speakUp(currentFax);
	  redraw();
  };

  var showHide = function(num, cb) {
	  show[num - 1] = cb.checked;
	  redraw();
  };

  var redraw = function() {
	  context.fillStyle = 'white';
	  context.fillRect(0, 0, canvas.width, canvas.height); // Clear
	  if (show[0] === true) {
		  context.drawImage(faxObj_1, topLeft[0][0], topLeft[0][1], (parseInt(faxObj_1.width) * zoom[0]), (parseInt(faxObj_1.height) * zoom[0]));
	  }
	  if (show[1] === true) {
		  context.drawImage(faxObj_2, topLeft[1][0], topLeft[1][1], (parseInt(faxObj_2.width) * zoom[1]), (parseInt(faxObj_2.height) * zoom[1]));
	  }
	  if (show[2] === true) {
		  context.drawImage(faxObj_3, topLeft[2][0], topLeft[2][1], (parseInt(faxObj_3.width) * zoom[2]), (parseInt(faxObj_3.height) * zoom[2]));
	  }
  };

  var changeFax = function(val) {
	  currentFax = val;
  };
    </script>
  </head>
  <body>
    <h2>Weather Wizard in HTML</h2>
    <table border="0">
      <tr>
        <td valign="top" rowspan="2">
          <div id="map" style="display: block; height: 700px; width: 850px; overflow-x: auto; overflow-y: auto; text-align: center;">
            <canvas id="mapCanvas" width="1000" height="900" style="border-radius:10px;"></canvas>
          </div>
        </td>
        <td valign="top">
          <input type="checkbox" onchange="changeGrid(this);" checked/> With Grid&nbsp;
	        <input type="checkbox" onchange="changeTropics(this);" /> With Tropics
					<hr/>
					<!-- Test -->
					<button onclick="loadFaxes();">Load faxes</button>
					<hr/>

					<div style="padding:5px; background:#fff; border-radius: 5px; overflow-y: auto; overflow-x: auto; border: 1px solid #CCC; margin-top: 10px;">
						<input type="checkbox" onchange="showHide(1, this);" checked>Show fax #1
						<br/>
						<input type="checkbox" onchange="showHide(2, this);" checked>Show fax #2
						<br/>
						<input type="checkbox" onchange="showHide(3, this);" checked>Show fax #3
						<hr/>
						<div id="fax-1">Fax 1:</div>
						<div id="fax-2">Fax 2:</div>
						<div id="fax-3">Fax 3:</div>
					</div>

					<div style="padding:5px; background:#fff; border-radius: 5px; overflow-y: auto; overflow-x: auto; border: 1px solid #CCC; margin-top: 10px;">
						Zoom factor: <input type="text" size="5" value="1.05" id="zoom-factor" style="text-align: right;"/>
						<br/>
						<input type="radio" name="faxnum" value="1" checked onclick="changeFax(this.value);">Fax #1
						<br/>
						<input type="radio" name="faxnum" value="2" onclick="changeFax(this.value);">Fax #2
						<br/>
						<input type="radio" name="faxnum" value="3" onclick="changeFax(this.value);">Fax #3
						<hr/>
						Zoom: <button onclick="zoomOut();">-</button><button onclick="zoomIn();">+</button>
						<hr/>
						<table>
							<tr><td colspan="3" align="center"><button onclick="up();">&#x25B2;</button></td></tr>
							<tr>
								<td align="center"><button onclick="left();">&#x25C0;</button></td>
								<td align="center" valign="center">&nbsp;&#x25CC;&nbsp;</td>
								<td align="center"><button onclick="right();">&#x25B6;</button></td>
							</tr>
							<tr><td colspan="3" align="center"><button onclick="down();">&#x25BC;</button></td></tr>
						</table>
					</div>

					<!-- End of Test -->
        </td>
      </tr>
	    <tr>
		    <td align="left">
			    <table>
				    <tr>
					    <td align="center">Width</td>
					    <td align="center">Height</td>
							<td align="center">Globe</td>
				    </tr>
				    <tr>
							<td>
								<button onclick="changeCanvasWidth(0.9);">-</button><button onclick="changeCanvasWidth(1.1);">+</button>
							</td>
					    <td>
						    <button onclick="changeCanvasHeight(0.9);">-</button><button onclick="changeCanvasHeight(1.1);">+</button>
					    </td>
							<td>
								<button onclick="changeZoomRatio(0.95);">-</button><button onclick="changeZoomRatio(1.05);">+</button>
							</td>
				    </tr>
						<tr>
							<td colspan="2" align="center">
								<button onclick="changeCanvasSize(0.9);">-</button><button onclick="changeCanvasSize(1.1);">+</button>
							</td>
							<td>
								<button onclick="resetZoomRatio();">Reset</button>
							</td>
						</tr>
			    </table>
		    </td>
      </tr>
      <tr>
        <td colspan="2">
          <div id="err-mess"></div>
        </td>
      </tr>
    </table>
    <address><span id="console-type"></span></address>
  </body>
</html>
  